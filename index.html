<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Blackjack — Twitch Overlay</title>
<script src="https://cdn.jsdelivr.net/npm/tmi.js/dist/tmi.min.js"></script>
<style>
  :root {
    --bg:#0c0f14; --panel:#121826; --accent:#20d3a6; --muted:#9aa4b2; --text:#eef2f7;
    --good:#45e39a; --bad:#ff6b6b; --warn:#ffb454; --outline:#2f3a5a; --card:#12203a;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial;overflow:hidden}
  .wrap{max-width:1600px;margin:auto;padding:12px;position:relative}
  .topbar{display:flex;gap:6px;align-items:center;margin-bottom:8px;flex-wrap:wrap;position:fixed;top:0;left:0;right:0;background:#0f1422;padding:8px;z-index:200}
  .topbar input{width:180px;padding:6px;border-radius:8px;border:1px solid rgba(255,255,255,.08);background:#0f1422;color:var(--text)}
  .badge{background:#1a233c;border:1px solid rgba(255,255,255,.1);padding:6px 10px;border-radius:999px;font-size:12px}
  .btn{background:var(--accent);color:#041a16;border:none;padding:6px 10px;border-radius:8px;font-weight:800;cursor:pointer;font-size:13px}
  .btn.alt{background:#253152;color:#dfe7f1}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .layout{display:grid;grid-template-columns:240px 1fr 340px;gap:12px;margin-top:60px}
  .panel{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px}
  .table{background:#0f1527;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px;position:relative;overflow:hidden}
  .dealer{margin-bottom:10px;padding:8px;border:1px dashed rgba(255,255,255,.12);border-radius:10px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .handbox{flex:1 1 260px;min-width:240px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:8px;position:relative}
  .handbox.active{box-shadow:0 0 0 2px var(--accent) inset}
  .handhead{display:flex;justify-content:space-between;margin-bottom:4px;font-weight:800}
  .cards{display:flex;gap:6px;flex-wrap:wrap;min-height:90px}
  .card{width:50px;height:70px;border-radius:8px;background:var(--card);border:1px solid rgba(255,255,255,.1);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:18px;position:relative}
  .card .sm{position:absolute;top:4px;left:6px;font-size:12px}
  .card.red{color:#ff8a8a}
  .card.hidden{background:linear-gradient(135deg,#1d2a52,#0f1732);border-color:#1b2446}
  .status{font-size:13px;color:var(--muted);min-height:18px}
  .timer{font-size:13px;font-weight:800;color:var(--warn);margin-top:2px}
  .result.win{color:var(--good)} .result.lose{color:var(--bad)} .result.push{color:var(--warn)}
  .list{max-height:220px;overflow:auto;font-size:14px;border:1px solid rgba(255,255,255,.08);border-radius:10px;background:#0f1422}
  .line{padding:6px 8px;border-bottom:1px solid rgba(255,255,255,.06)}
  .chat{max-height:260px;overflow:auto;background:#0f1422;border-radius:8px;border:1px solid rgba(255,255,255,.08);padding:6px}
  .chat .msg{font-size:13px;color:#d1d7e6;border-bottom:1px solid rgba(255,255,255,.06);padding:3px 2px}
  .flash{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(32,211,166,0.95);color:#041a16;padding:16px 28px;border-radius:14px;font-size:18px;font-weight:800;opacity:0;pointer-events:none;transition:opacity .3s ease;z-index:100;max-width:90%;text-align:center}
  .flash.show{opacity:1;}
  .compact .handbox{flex:1 1 150px;min-width:150px;max-width:150px;padding:6px}
  .compact .handhead{font-size:12px}
  .compact .cards{min-height:50px;gap:4px}
  .compact .card{width:28px;height:40px;font-size:12px;border-radius:6px}
  .compact .card .sm{top:3px;left:5px;font-size:10px}
  .scorechip{position:absolute;top:6px;right:6px;background:#142038;border:1px solid var(--outline);border-radius:999px;padding:2px 6px;font-size:11px;font-weight:800;color:#dfe7ff}
  .minilog{position:absolute;bottom:4px;left:4px;right:4px;font-size:10px;line-height:1.15;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.15);border-radius:6px;padding:3px 5px;color:#dde3f3;max-height:40px;overflow:hidden}
  .rules{font-size:13px;line-height:1.5}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <input id="channelInput" type="text" placeholder="Twitch channel">
    <button id="connectBtn" class="btn">Connect</button>
    <span class="badge" id="conn">Not connected</span>
    <button id="modeBtn" class="btn alt">Mode: Turn-Based</button>
    <button id="startBtn" class="btn">Start Round</button>
    <button id="stopBtn" class="btn alt">Stop Round</button>
    <button id="resetQueueBtn" class="btn alt">Reset Queue</button>
    <button id="resetBalancesBtn" class="btn alt">Reset Balances</button>
    <button id="resetEarningsBtn" class="btn alt">Reset Leaderboard</button>
  </div>

  <div class="layout">
    <div class="panel rules">
      <h3>Rules</h3>
      <ul>
        <li>Type <b>!join</b> to enter the queue.</li>
        <li>Type <b>!bet X</b> to place a bet (10–1000 or "all").</li>
        <li>Type <b>!hit</b> or <b>!stand</b> during your turn.</li>
        <li>Type <b>!give X user</b> to transfer money. <br>Use <b>!give all user</b> to give your entire balance.</li>
        <li>Type <b>!money</b> to check your balance.</li>
        <li>Mods: <b>!add X user</b>, <b>!addall X</b>, <b>!resetbalances</b>.</li>
      </ul>
    </div>

    <div id="tablePanel" class="table panel">
      <div class="dealer">
        <div class="row" style="justify-content:space-between;">
          <div><b>Dealer</b> <span id="dealerScore">-</span></div>
          <div id="roundInfo">Waiting for players…</div>
        </div>
        <div class="cards" id="dealerCards"></div>
      </div>
      <div id="playersRow" class="row"></div>
      <div id="flashMsg" class="flash"></div>
    </div>

    <div>
      <div class="panel"><h2>Queue</h2><div id="queueList" class="list"></div></div>
      <div class="panel"><h2>Joins</h2><div id="joinList" class="list"></div></div>
      <div class="panel"><h2>Chat</h2><div id="chatBox" class="chat"></div></div>
      <div class="panel"><h2>Leaderboard (Top 5)</h2><div id="earningsBoard" class="list"></div></div>
    </div>
  </div>
</div>

<script>
/* ===== State ===== */
let client=null, shoe=[], dealer={}, inRound=false;
let activePlayers=[], queue=[], playMode='turn', lockedMode=null, turnIdx=-1;
let balances={}, bets={}, allTimeEarnings=JSON.parse(localStorage.getItem('bjAllEarnings')||'{}');
const START_BALANCE=1000, TURN_TIMEOUT=20, ALL_TIMEOUT=20;
const $=id=>document.getElementById(id);

/* ===== Helpers ===== */
function flashMessage(msg){const f=$('flashMsg');f.innerHTML=msg;f.classList.add('show');setTimeout(()=>f.classList.remove('show'),2500);}
function pushChat(n,m){const cb=$('chatBox');const d=document.createElement('div');d.className='msg';d.innerHTML=`<b>${n}:</b> ${m}`;cb.appendChild(d);cb.scrollTop=cb.scrollHeight;}
function pushJoinMsg(txt){const jl=$('joinList');const d=document.createElement('div');d.className='line';d.textContent=txt;jl.prepend(d);while(jl.childElementCount>60)jl.lastChild.remove();}
function saveAll(){localStorage.setItem('bjAllEarnings',JSON.stringify(allTimeEarnings));}
function renderEarnings(){const board=$('earningsBoard');const top=Object.entries(allTimeEarnings).sort((a,b)=>b[1]-a[1]).slice(0,5);board.innerHTML=top.length?top.map(([n,v],i)=>`<div class="line">${i+1}. ${n} — $${v}</div>`).join(''):'<div class="line">No earnings yet</div>';}

/* ===== Cards ===== */
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}}
function buildShoe(){const r=['A','2','3','4','5','6','7','8','9','10','J','Q','K'],s=['♠','♥','♦','♣'];shoe=[];for(let d=0;d<6;d++){for(const rr of r){for(const ss of s)shoe.push({r:rr,s:ss});}}shuffle(shoe);}
function draw(){if(shoe.length===0)buildShoe();return shoe.pop();}
function bestValue(cards){let t=0,a=0;for(const c of cards){if(c.r==='A'){a++;t+=11;}else if(['10','J','Q','K'].includes(c.r))t+=10;else t+=+c.r;}while(t>21&&a>0){t-=10;a--;}return t;}
function isSoft(cards){let t=0,a=0;for(const c of cards){if(c.r==='A'){a++;t+=11;}else if(['10','J','Q','K'].includes(c.r))t+=10;else t+=+c.r;}while(t>21&&a>0){t-=10;a--;}return a>0;}
function cardEl(c,h=false){const d=document.createElement('div');d.className='card'+((c?.s==='♥'||c?.s==='♦')?' red':'');if(h){d.classList.add('hidden');return d;}const sm=document.createElement('div');sm.className='sm';sm.textContent=c.r;d.appendChild(sm);const big=document.createElement('div');big.textContent=c.s;d.appendChild(big);return d;}

/* ===== Render ===== */
function render(){
  const table=$('tablePanel');if(activePlayers.length>10) table.classList.add('compact'); else table.classList.remove('compact');
  const dc=$('dealerCards');dc.innerHTML='';dealer.hand?.forEach((c,i)=>dc.appendChild(cardEl(c,!dealer.reveal&&i===1)));$('dealerScore').textContent=dealer.reveal?bestValue(dealer.hand||[]):(dealer.hand?.[0]?bestValue([dealer.hand[0]]):'-');
  const row=$('playersRow');row.innerHTML='';activePlayers.forEach((p,i)=>{const box=document.createElement('div');box.className='handbox';if(lockedMode==='turn'&&inRound&&i===turnIdx)box.classList.add('active');const head=document.createElement('div');head.className='handhead';const score=bestValue(p.hand||[]);head.innerHTML=`<span>${p.name}</span><span>$${balances[p.name]||START_BALANCE}</span>`;const scoreChip=document.createElement('div');scoreChip.className='scorechip';scoreChip.textContent=`${score} (${(p.hand||[]).length}c)`;const cards=document.createElement('div');cards.className='cards';(p.hand||[]).forEach(c=>cards.appendChild(cardEl(c)));box.append(head,cards,scoreChip);row.appendChild(box);});$('queueList').innerHTML=queue.length?queue.map((n,i)=>`<div class="line">${i+1}. ${n}</div>`).join(''):'<div class="line">Queue empty</div>';renderEarnings();}

/* ===== Commands ===== */
function givePoints(sender,amt,target,allFlag=false){if(inRound)return;let sBal=balances[sender]??START_BALANCE;if(allFlag){amt=sBal;}else{amt=parseInt(amt,10);if(isNaN(amt)||amt<=0||sBal<amt)return;}if(sBal<=0)return;balances[sender]=sBal-amt;balances[target]=(balances[target]??START_BALANCE)+amt;flashMessage(`${sender} gave $${amt} to ${target}`);saveAll();render();}

/* ===== Twitch ===== */
function connectTwitch(ch){try{if(client)client.disconnect();}catch(_){ }client=new tmi.Client({connection:{secure:true,reconnect:true},channels:[ch]});client.connect().then(()=>$('conn').textContent=`Connected: ${ch}`);client.on('message',(chan,tags,msg,self)=>{if(self)return;const name=tags['display-name']||tags.username;const text=msg.trim();const low=text.toLowerCase();pushChat(name,text);
  if(low==='!join'){if(!queue.includes(name))queue.push(name);flashMessage(`${name} joined queue`);render();}
  if(low.startsWith('!bet ')){if(inRound)return;const amt=text.split(' ')[1];bets[name]=amt;flashMessage(`${name} bet ${amt}`);}
  if(low==='!hit'){flashMessage(`${name} hits`);} 
  if(low==='!stand'){flashMessage(`${name} stands`);} 
  if(low==='!money'){flashMessage(`${name} has $${balances[name]||START_BALANCE}`);}
  if(low.startsWith('!give ')){if(inRound)return;const parts=text.split(/\s+/);let amtPart=(parts[1]||'').toLowerCase();const target=parts.slice(2).join(' ').trim();if(!target)return;if(amtPart==='all'){givePoints(name,0,target,true);}else{const amt=parseInt(amtPart,10);if(amt)givePoints(name,amt,target);}}
});}

/* ===== Controls ===== */
$('connectBtn').onclick=()=>{const ch=$('channelInput').value.trim();if(ch)connectTwitch(ch);};
$('modeBtn').onclick=()=>{if(inRound)return;playMode=(playMode==='turn')?'all':'turn';$('modeBtn').textContent='Mode: '+(playMode==='turn'?'Turn-Based':'All-at-Once');};
$('resetEarningsBtn').onclick=()=>{allTimeEarnings={};saveAll();renderEarnings();flashMessage('Leaderboard reset');};
$('resetBalancesBtn').onclick=()=>{balances={};bets={};queue.push(...activePlayers.map(p=>p.name));activePlayers=[];inRound=false;flashMessage('Balances reset — players moved to queue');render();};
$('resetQueueBtn').onclick=()=>{queue=[];flashMessage('Queue cleared');render();};
$('stopBtn').onclick=()=>{inRound=false;activePlayers=[];flashMessage('Round stopped');render();};

/* ===== Init ===== */
(function init(){buildShoe();render();})();
</script>
</body>
</html>
